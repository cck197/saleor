{% extends "base_new.html" %}
{% load i18n %}
{% load get_product_image_thumbnail from product_images %}
{% load price from taxed_prices %}
{% load static %}
{% load bootstrap_form from bootstrap4 %}
{% load bootstrap_field from bootstrap4 %}
{% load get_product_features from product_attr %}
{% load get_product_price_features from product_attr %}

{% block shipping_options %}{% url 'checkout:shipping-options-single' %}{% endblock %}
{% block title %}{% trans "Last Step - Get Your..." context "Checkout page title" %} â€” {{ block.super }}{% endblock %}

{% block meta_tags %}
  <meta name="robots" content="nofollow">
{% endblock meta_tags %}

{% block content %}
<div class="container pb-3">
  <div class="row">
    <div class="col-5 p-3">
      <img class="img-fluid" src="{% static "images/logo-ks.png" %}"/>
    </div>
  </div>
  <div class="row">
    <div class="col-md-7 order-md-12">
      <h2>{% trans "Order Summary" context "Checkout order summary title" %}</h2>
      <div class="checkout-preview">
        {% if checkout_lines %}
          <div class="table__header d-none d-md-block">
            <div class="row">
              <div class="col-md-9">
                <small>{% trans "Product" context "Checkout table header" %}</small>
              </div>
              <div class="col-md-3 text-right">
                <small>{% trans "Price" context "Checkout table header" %}</small>
              </div>
            </div>
          </div>
          {% for line in checkout_lines %}
          <div class="checkout-preview__line{% if forloop.last %} last{% endif %} table__row">
            <div class="row">
              <div class="col-9 checkout-preview__line__product">
                <div class="row">
                  <div class="col-lg-auto col-sm-auto col-md-auto">
                    <img class="lazyload lazypreload" data-src="{% get_product_image_thumbnail line.variant.get_first_image method="thumbnail" size=90 %}"
                       data-srcset="{% get_product_image_thumbnail line.variant.get_first_image method="thumbnail" size=90 %} 1x, {% get_product_image_thumbnail line.variant.get_first_image method="thumbnail" size=180 %} 2x"
                       alt=""/>
                  </div>
                  <div class="col-lg-auto col-sm-auto col-md-auto">
                    <p>
                      {{ line.variant.product.translated }}
                      {% get_product_price_features line.variant.product as features %}
                      {% if features %}
                        <br/>
                        <small><b>({{ features|join:", " }})</b></small>
                      {% endif %}
                      {% get_product_features line.variant.product as features %}
                      {% if features %}
                      <br/>
                      <small>{{ features|join:"<br/>" }}</small>
                      {% endif %}
                    </p>
                  </div>
                </div>
              </div>
              <div class="col-3">
                {% with pun=line.variant.get_price pd=line.get_total %}
                <p class="text-right">
                  {% if pun != pd %}
                  <small class="product__info__price__undiscounted">
                    {% price pun %}
                  </small>
                  {% endif %}
                  {% price pd %}
                </p>
                {% endwith %}
              </div>
            </div>
          </div>
          {% endfor %}
          {% if cheesy_clock %}
          <div id="clock__container">
            <p>{% trans "Time Left to Confirm" context "Countdown timer" %}</p>
						<div id="clockdiv">
              <span class="minutes"></span>:<span class="seconds"></span>
						</div>
          </div>
          {% endif %}
          <div class="checkout__subtotal">
            {% include 'checkout/_subtotal_table.html' with country_code=shipping.address_form.initial.country %}
          </div>
        {% endif %}
        <p class="text-center"><small class="text-muted">60 Day Money Back Guarantee<br/>100% No Questions Asked</small></p>
      </div>
    </div>
    <div class="col-md-5 order-sm-1">
      <form method="POST" id="payment-form" novalidate>
        <input type="hidden" id="gateway" name="gateway" value="Stripe"/>
        <h2>{% trans "Contact Information" context "Checkout contact information title" %}:</h2>
        {% csrf_token %}
        {% bootstrap_field shipping.address_form.first_name show_label=False %}
        {% bootstrap_field shipping.address_form.last_name show_label=False %}
        {% bootstrap_field shipping.user_form.email show_label=False %}
        <hr/>
        <h2>{% trans "Shipping Information" context "Checkout shipping information title" %}</h2>
        {% include "account/snippets/address_form_single.html" with address_form=shipping.address_form only %}

        {% if not Stripe and not Braintree  %}
        <button type="submit" id="card-button" class="btn btn-primary btn-block">
          {% trans "Place Order" context "Payment form primary action" %}
        </button>
        {% else %}
        <hr/>
        <h2>{% trans "Payment Information" context "Checkout payment information title" %}</h2>
				<ul class="nav nav-tabs col-lg-10 m-auto" role="tablist">
          {% if Stripe %}
					<li class="nav-item">
						<a class="nav-link active" data-toggle="tab" href="#card" role="tab" aria-selected="true">
							<h3>Credit Card</h3>
						</a>
					</li>
          {% endif %}
          {% if Braintree %}
					<li class="nav-item">
						<a class="nav-link" data-toggle="tab" href="#paypal" role="tab" aria-selected="false">
							<h3>PayPal</h3>
						</a>
					</li>
          {% endif %}
				</ul>
				<div class="tab-content">
          {% if Stripe %}
					<div class="tab-pane fade active show" id="card" role="tabpanel">
						<div class="m-auto">
              {% include 'order/payment/stripe_inner.html' with form=Stripe.form payment=Stripe.payment client_token=Stripe.client_token order=order %}
						</div>
					</div>
          {% endif %}
          {% if Braintree %}
					<div class="tab-pane fade" id="paypal" role="tabpanel">
						<div class="m-auto">
							<div class="alert alert-danger">
								<span contenteditable="true">An approval dialog box will appear for secure PayPal payment</span>
							</div>
              {% include 'order/payment/paypal.html' with form=Braintree.form payment=Braintree.payment client_token=Braintree.client_token order=order %}
						</div>
					</div>
          {% endif %}
				</div>
        {% endif %}
      </form>
    </div>
  </div>
</div>
{% endblock %}
