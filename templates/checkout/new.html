{% extends "base_new.html" %}
{% load i18n %}
{% load get_product_image_thumbnail from product_images %}
{% load price from taxed_prices %}
{% load static %}
{% load bootstrap_form from bootstrap4 %}
{% load bootstrap_field from bootstrap4 %}
{% load get_product_features from product_attr %}
{% load get_product_price_features from product_attr %}

{% block shipping_options %}{% url 'checkout:shipping-options-single' %}{% endblock %}
{% block title %}{% trans "Last Step - Get Your..." context "Checkout page title" %} â€” {{ block.super }}{% endblock %}

{% block meta_tags %}
  <meta name="robots" content="nofollow">
{% endblock meta_tags %}

{% block content %}
<div class="container pb-3 pr-0 pl-0">
  <div class="row">
    <div class="col-4 p-3">
      <img class="cart-logo img-fluid" src="{% static "images/logo-ks.png" %}"/>
    </div>
  </div>
  <div class="row">
    <div class="col-md-6 order-md-12">
      <h3><svg data-src="{% static "images/shopping-cart-solid.svg" %}" width="20" height="20"/> {% trans "Order Summary" context "Checkout order summary title" %}</h3>
      <div class="checkout-preview">
        {% if checkout_lines %}
          {% for line in checkout_lines %}
          <div class="checkout-preview__line{% if forloop.last %} last{% endif %} table__row">
            <div class="checkout-product__title row d-flex justify-content-center">
              {{ line.variant.product.translated }}
            </div>
            <div class="checkout-product__price row d-flex justify-content-center">
              {% with pun=line.variant.get_price pd=line.get_total %}
              {% if pun != pd %}
              <small class="product__info__price__undiscounted">
                {% price pun %}
              </small> &nbsp;
              {% endif %}
              {% price pd %}
              {% endwith %}
            </div>
            <div class="row d-flex justify-content-center">
              {% get_product_price_features line.variant.product as features %}
              {% if features %}
                <br/>
                <small><b>({{ features|join:", " }})</b></small>
              {% endif %}
            </div>
            <div class="row d-flex justify-content-center">
                <img class="lazyload lazypreload" data-src="{% get_product_image_thumbnail line.variant.get_first_image method="thumbnail" size=180 %}"
                   data-srcset="{% get_product_image_thumbnail line.variant.get_first_image method="thumbnail" size=180 %} 1x, {% get_product_image_thumbnail line.variant.get_first_image method="thumbnail" size=360 %} 2x"
                   alt=""/>
            </div>
            {% get_product_features line.variant.product as features %}
            {% if features %}
            <div class="row d-flex justify-content-center">
              You get:
              <small><ul>
                {% for feature in features %}
                <li>{{ feature }}</li>
                {% endfor %}
              </small></ul>
            </div>
            {% endif %}
          </div>
          {% endfor %}
          {% if cheesy_clock %}
          <div id="clock__container">
            <div class="row d-flex justify-content-center">
              <p>{% trans "Time Left to Confirm" context "Countdown timer" %}</p>
            </div>
						<div id="clockdiv" class="d-flex justify-content-center">
              <span class="minutes"></span>:<span class="seconds"></span>
						</div>
          </div>
          {% endif %}
          <div class="checkout__subtotal">
            {% include 'checkout/_subtotal_table.html' with country_code=shipping.address_form.initial.country %}
          </div>
        {% endif %}
        <p class="text-center"><small class="text-muted">60 Day Money Back Guarantee<br/>100% No Questions Asked</small></p>
      </div>
    </div>
    <div class="col-md-6 order-sm-1">
      <form method="POST" id="payment-form" novalidate>
        <input type="hidden" id="gateway" name="gateway" value="Stripe"/>
        <h3>{% trans "Contact Information" context "Checkout contact information title" %}</h3>
        {% csrf_token %}
        {% bootstrap_field shipping.address_form.first_name show_label=False %}
        {% bootstrap_field shipping.address_form.last_name show_label=False %}
        {% bootstrap_field shipping.user_form.email show_label=False %}
        <hr/>
        <h3>{% trans "Shipping Information" context "Checkout shipping information title" %}</h3>
        {% include "account/snippets/address_form_single.html" with address_form=shipping.address_form only %}

        {% if not Stripe and not Braintree  %}
        <button type="submit" id="card-button" class="btn btn-primary btn-block">
          {% trans "Place Order" context "Payment form primary action" %}
        </button>
        {% else %}
        <hr/>
        <h3>{% trans "Payment Information" context "Checkout payment information title" %}</h3>
				<ul class="nav nav-tabs col-lg-10 m-auto" role="tablist">
          {% if Stripe %}
					<li class="nav-item">
						<a class="nav-link active" data-toggle="tab" href="#card" role="tab" aria-selected="true">
							<h3>Credit Card</h3>
						</a>
					</li>
          {% endif %}
          {% if Braintree %}
					<li class="nav-item">
						<a class="nav-link" data-toggle="tab" href="#paypal" role="tab" aria-selected="false">
							<h3>PayPal</h3>
						</a>
					</li>
          {% endif %}
				</ul>
				<div class="tab-content">
          {% if Stripe %}
					<div class="tab-pane fade active show" id="card" role="tabpanel">
						<div class="m-auto">
              {% include 'order/payment/stripe_inner.html' with form=Stripe.form payment=Stripe.payment client_token=Stripe.client_token order=order %}
						</div>
					</div>
          {% endif %}
          {% if Braintree %}
					<div class="tab-pane fade" id="paypal" role="tabpanel">
						<div class="m-auto">
							<div class="alert alert-danger">
								<span contenteditable="true">An approval dialog box will appear for secure PayPal payment</span>
							</div>
              {% include 'order/payment/paypal.html' with form=Braintree.form payment=Braintree.payment client_token=Braintree.client_token order=order %}
						</div>
					</div>
          {% endif %}
				</div>
        {% endif %}
      </form>
    </div>
  </div>
</div>
{% endblock %}
